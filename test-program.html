<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aegis Regression Test</title>
    <style>
      body {
        margin: 0;
        font-family: "Consolas", "Menlo", monospace;
        background: #0f1115;
        color: #e7edf5;
      }
      #panel {
        position: fixed;
        top: 12px;
        left: 12px;
        right: 12px;
        z-index: 20;
        background: rgba(10, 12, 16, 0.88);
        border: 1px solid #2a3240;
        border-radius: 10px;
        padding: 12px;
        max-width: 780px;
      }
      #results {
        white-space: pre-wrap;
        font-size: 13px;
        line-height: 1.5;
      }
      .ok {
        color: #7ee787;
      }
      .fail {
        color: #ff7b72;
      }
    </style>
  </head>
  <body>
    <div id="panel">
      <div><b>Aegis Regression Test</b></div>
      <div id="results">Preparing test environment...</div>
    </div>

    <script>
      (function loadThreeWithFallback() {
        const sources = [
          "https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js",
          "https://cdn.jsdelivr.net/npm/three/build/three.min.js",
          "https://unpkg.com/three/build/three.min.js",
        ];

        let index = 0;
        function loadNext() {
          if (index >= sources.length) {
            document.getElementById("results").textContent =
              "Failed to load Three.js from all CDN sources.";
            return;
          }
          const script = document.createElement("script");
          script.src = sources[index];
          script.onload = function () {
            const main = document.createElement("script");
            main.src = "./main.js";
            main.defer = true;
            document.body.appendChild(main);
          };
          script.onerror = function () {
            index += 1;
            loadNext();
          };
          document.head.appendChild(script);
        }
        loadNext();
      })();
    </script>

    <script>
      function waitForApi(timeoutMs) {
        const started = performance.now();
        return new Promise((resolve, reject) => {
          const timer = setInterval(() => {
            if (window.__AegisTestAPI) {
              clearInterval(timer);
              resolve(window.__AegisTestAPI);
              return;
            }
            if (performance.now() - started > timeoutMs) {
              clearInterval(timer);
              reject(new Error("__AegisTestAPI not found"));
            }
          }, 50);
        });
      }

      function runTests(api) {
        const lines = [];
        let passed = 0;
        let failed = 0;

        function expect(name, condition, details) {
          if (condition) {
            passed += 1;
            lines.push("[PASS] " + name + (details ? " - " + details : ""));
          } else {
            failed += 1;
            lines.push("[FAIL] " + name + (details ? " - " + details : ""));
          }
        }

        api.resetBattle();
        api.setHeroDead();
        api.step(0.016, 1.0);
        const heroPose = api.getHeroDeadPose();
        expect(
          "Hero dead pose stays upright",
          Math.abs(heroPose.hipsZ) < 0.25,
          "hipsZ=" + heroPose.hipsZ.toFixed(3)
        );

        api.resetBattle();
        api.setMinotaurDead();
        api.step(0.016, 1.0);
        const minotaurPose = api.getMinotaurDeadPose();
        expect(
          "Minotaur dead pose stays upright",
          Math.abs(minotaurPose.hipsZ) < 0.25,
          "hipsZ=" + minotaurPose.hipsZ.toFixed(3)
        );

        api.resetBattle();
        api.setMinotaurDead();
        api.setHeroPosition(0, 0);
        api.setHeroRotationY(Math.PI);
        api.setCamera({ x: 0, y: 6, z: 12 }, { x: 0, y: 1, z: 0 });
        const expectedForwardMove = api.computeMoveVector(0, 1);
        api.setKeys({ KeyW: true });
        const beforeMove = api.getHeroPosition();
        api.step(0.1, 2.0);
        api.setKeys({});
        const afterMove = api.getHeroPosition();
        const actualMove = afterMove.clone().sub(beforeMove).normalize();
        const dot = actualMove.dot(expectedForwardMove);
        expect("W uses camera-relative forward", dot > 0.85, "dot=" + dot.toFixed(3));

        api.resetBattle();
        api.setMinotaurDead();
        api.setCamera({ x: 0, y: 6, z: 12 }, { x: 0, y: 1, z: 0 });
        api.setHeroPosition(15.7, 0.0);
        api.setHeroRotationY(-Math.PI / 2);
        api.setKeys({ KeyD: true });
        api.step(0.1, 3.0);
        api.setKeys({});

        const expectedAfterWall = api.computeMoveVector(0, 1);
        const beforeWallForward = api.getHeroPosition();
        api.setKeys({ KeyW: true });
        api.step(0.1, 3.2);
        api.setKeys({});
        const afterWallForward = api.getHeroPosition();
        const actualAfterWall = afterWallForward.clone().sub(beforeWallForward);
        const movedEnough = actualAfterWall.lengthSq() > 0.0001;
        if (movedEnough) {
          actualAfterWall.normalize();
        }
        const dotAfterWall = movedEnough ? actualAfterWall.dot(expectedAfterWall) : -1;
        expect(
          "After wall contact, W keeps camera-relative direction",
          movedEnough && dotAfterWall > 0.7,
          movedEnough ? "dot=" + dotAfterWall.toFixed(3) : "no movement"
        );

        lines.unshift("Result: " + passed + " passed, " + failed + " failed");
        return { lines, failed };
      }

      (async function main() {
        const resultEl = document.getElementById("results");
        try {
          const api = await waitForApi(8000);
          const result = runTests(api);
          resultEl.innerHTML = result.lines
            .map((line) => {
              if (line.startsWith("[PASS]")) {
                return '<span class="ok">' + line + "</span>";
              }
              if (line.startsWith("[FAIL]")) {
                return '<span class="fail">' + line + "</span>";
              }
              return line;
            })
            .join("\n");
        } catch (error) {
          resultEl.textContent = "Test bootstrap failed: " + error.message;
        }
      })();
    </script>
  </body>
</html>
